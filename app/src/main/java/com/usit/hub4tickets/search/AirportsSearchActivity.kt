package com.usit.hub4tickets.searchimport android.app.Activityimport android.content.Contextimport android.content.Intentimport android.os.Bundleimport android.support.annotation.RawResimport android.support.v7.widget.LinearLayoutManagerimport android.support.v7.widget.RecyclerViewimport android.support.v7.widget.SearchViewimport android.util.Logimport android.view.Viewimport com.google.gson.Gsonimport com.usit.hub4tickets.Rimport com.usit.hub4tickets.domain.presentation.presenters.FlightPresenterimport com.usit.hub4tickets.domain.presentation.screens.BaseActivityimport com.usit.hub4tickets.domain.presentation.screens.main.FlightPresenterImplimport com.usit.hub4tickets.flight.model.FlightViewModelimport com.usit.hub4tickets.search.model.AirportsSelectorPojoimport com.usit.hub4tickets.utils.PrefConstantsimport com.usit.hub4tickets.utils.Utilityimport kotlinx.android.synthetic.main.activity_comman_serach.*import org.json.JSONObject/** * Created by Bhagyashri Burade * Date: 24/10/2018 * Email: bhagyashri.burade@usit.net.in */class AirportsSearchActivity : BaseActivity(), FlightPresenter.MainView {    private var searchItemsListAdapter: AirportsSearchAdapter? = null    private var strActivityTitle: String? = ""    private lateinit var model: FlightViewModel    private lateinit var presenter: FlightPresenter    private var arrayListCommonSelectorFromInitial: ArrayList<FlightViewModel.AirPortDataResponse.ResponseData> =        ArrayList()    override fun showState(viewState: FlightPresenter.MainView.ViewState) {        when (viewState) {            FlightPresenter.MainView.ViewState.IDLE -> Utility.showProgress(false, this)            FlightPresenter.MainView.ViewState.LOADING -> Utility.showProgress(true, this)            FlightPresenter.MainView.ViewState.SUCCESS_FROM -> {                arrayListCommonSelectorFromInitial.addAll(model.flightViewModel.responseData as ArrayList<FlightViewModel.AirPortDataResponse.ResponseData>)            }            FlightPresenter.MainView.ViewState.SUCCESS_TO -> {                arrayListCommonSelectorFromInitial.addAll(model.flightViewModel.responseData as ArrayList<FlightViewModel.AirPortDataResponse.ResponseData>)                initView()            }            FlightPresenter.MainView.ViewState.ERROR            -> {                arrayListCommonSelectorFromInitial?.clear()                searchItemsListAdapter?.notifyDataSetChanged()                presenter.presentState(FlightPresenter.MainView.ViewState.IDLE)                Utility.showCustomDialog(this, doRetrieveModel().errorMessage.message, "", null)            }        }    }    override fun doRetrieveModel(): FlightViewModel = this.model    inline fun <reified T> Context.jsonToClass(@RawRes resourceId: Int): T =        Gson().fromJson(resources.openRawResource(resourceId).bufferedReader().use { it.readText() }, T::class.java)    override fun onCreate(savedInstanceState: Bundle?) {        super.onCreate(savedInstanceState)        setContentView(R.layout.activity_comman_serach)        this.model = FlightViewModel(this)        this.presenter = FlightPresenterImpl(this, this)        var searchTextView = this.findViewById<SearchView>(R.id.search_text)        searchTextView.setOnQueryTextListener(object : SearchView.OnQueryTextListener {            override fun onQueryTextSubmit(query: String?): Boolean {                query?.replace("\\s+$".toRegex(), "")                searchItemsListAdapter?.getFilter()?.filter(query)                return false            }            override fun onQueryTextChange(newText: String?): Boolean {                searchItemsListAdapter?.getFilter()?.filter(newText!!.trim { it <= ' ' })                return false            }        })        /* if (intent.extras != null) {             callAPIAirportData(intent.getStringExtra(Constant.Path.FLAG), "")         }*/        if (arrayListCommonSelectorFromInitial.isNullOrEmpty()) {            arrayListCommonSelectorFromInitial.clear()            var airports: ArrayList<FlightViewModel.AirPortDataResponse.ResponseData> = ArrayList()            try {                assets.open("airports.json")                application.assets.open("airports.json").apply {                    var inputString = this.readBytes().toString(Charsets.UTF_8)                    val obj = JSONObject(inputString)                    val countries = obj.getJSONArray("responseData")                    for (i in 0 until countries.length()) {                        val jsonObject = countries.getJSONObject(i)                        val airPortCode = jsonObject.getString("airPortCode")//id                        val nameAndCode = jsonObject.getString("airPortNameAndCode")                        val airPortCity = jsonObject.getString("airportCity")//code                        val airPortCountry = jsonObject.getString("airPortCountry")//code                        val airPortId = jsonObject.getString("airPortId")//code                        airports.add(                            FlightViewModel.AirPortDataResponse.ResponseData(                                airPortId,                                airPortCode,                                nameAndCode,                                airPortCity,                                airPortCountry                            )                        )                    }                }.close()            } catch (e: Exception) {                Log.d("", e.toString())            }            model.flightViewModel.responseData = airports        }        arrayListCommonSelectorFromInitial.addAll(model.flightViewModel.responseData as ArrayList<FlightViewModel.AirPortDataResponse.ResponseData>)        initView()    }    /* private fun loadJSONFromAsset(): String? {         var json: String? = null         try {             val `is` = assets.open("airports.json")             val size = `is`.available()             val buffer = ByteArray(size)             `is`.read(buffer)             `is`.close()             json = String(buffer, charset("UTF-8"))         } catch (ex: IOException) {             ex.printStackTrace()             return null         }         return json     }*/    private fun initView() {        val arrayListCommonSelector: ArrayList<AirportsSelectorPojo> = ArrayList()        if (arrayListCommonSelectorFromInitial != null) {            for (i in arrayListCommonSelectorFromInitial!!.indices) {                arrayListCommonSelector.add(                    i, AirportsSelectorPojo(                        arrayListCommonSelectorFromInitial[i].airPortId.toString(),                        arrayListCommonSelectorFromInitial[i].airPortCode.toString(),                        arrayListCommonSelectorFromInitial[i].airPortNameAndCode,                        arrayListCommonSelectorFromInitial[i].airportCity,                        arrayListCommonSelectorFromInitial[i].airPortCountry                    )                )            }        }        if (null != arrayListCommonSelector) {            searchItemsListAdapter = AirportsSearchAdapter(                strActivityTitle,                arrayListCommonSelector,                object : AirportsSearchAdapter.OnItemClickListener {                    override fun onListItemClick(data: AirportsSelectorPojo) {                        Utility.hideKeyBordActivity(this@AirportsSearchActivity)                        val intent = Intent()                        intent.putExtra(PrefConstants.SELECTED_AIRPORT_ID, data.airPortId)                        intent.putExtra(PrefConstants.SELECTED_AIRPORT_CODE, data.airPortCode)                        intent.putExtra(PrefConstants.SELECTED_AIRPORT_NAME, data.airPortNameAndCode)                        intent.putExtra(PrefConstants.SELECTED_AIRPORT_CITY, data.airportCity)                        intent.putExtra(PrefConstants.SELECTED_AIRPORT_COUNTRY, data.airPortCountry)                        setResult(Activity.RESULT_OK, intent)                        finish()                    }                    override fun onNoData(isVisible: Boolean) {                        if (isVisible) {                            txt_no_data!!.visibility = View.VISIBLE                        } else {                            txt_no_data!!.visibility = View.GONE                        }                    }                })            val mLayoutManager = LinearLayoutManager(this)            recycler_city_list!!.layoutManager = mLayoutManager as RecyclerView.LayoutManager?            recycler_city_list!!.adapter = searchItemsListAdapter        }    }    override fun onBackPressed() {        Utility.hideKeyBordActivity(this)        super.onBackPressed()    }    private fun callAPIAirportData(flag: String?, toString: String) {        presenter.callAPIAirportData(flag, toString)    }    override fun getLayoutResource(): Int {        return R.layout.common_toolbar    }}